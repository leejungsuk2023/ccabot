# AI Response Optimization and Data Management

## ğŸ§  AI Response Quality Issues

### Problem: AI Ignores Updated FAQ Data
**Symptoms**: AI continues giving old responses despite CSV updates
**Root Cause**: Data synchronization issues between CSV and Firestore

### Solution: Enhanced Data Verification
```javascript
// In [functions/index.js](mdc:functions/index.js), add detailed logging
console.log('ğŸ” [AI] Firestoreì—ì„œ ì¡°íšŒí•œ FAQ ë°ì´í„°:', faqsInfo);
console.log('ğŸ” [AI] FAQ ë¬¸ì„œ ì¡´ì¬ ì—¬ë¶€:', faqsDoc.exists);
console.log('ğŸ” [AI] FAQ ë¬¸ì„œ ID:', faqsDoc.id);
```

## ğŸ“Š Data Synchronization Best Practices

### 1. CSV to Firestore Update Process
```javascript
// In [functions/update_ai_brain.js](mdc:functions/update_ai_brain.js)
async function updateFirestoreDocument(collection, documentId, data) {
  try {
    console.log(`ğŸ” [UPDATE] ${collection}/${documentId} ì—…ë°ì´íŠ¸ ì‹œì‘`);
    console.log(`ğŸ” [UPDATE] ì €ì¥í•  ë°ì´í„°:`, JSON.stringify(data, null, 2));
    
    await db.collection(collection).doc(documentId).set({
      content: data,
      updatedAt: admin.firestore.FieldValue.serverTimestamp(),
      version: '1.0'
    });
    
    // Verify saved data
    const savedDoc = await db.collection(collection).doc(documentId).get();
    console.log(`ğŸ” [UPDATE] ì €ì¥ëœ ë°ì´í„° í™•ì¸:`, JSON.stringify(savedDoc.data(), null, 2));
  } catch (error) {
    console.error(`âŒ ${collection}/${documentId} ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:`, error);
    throw error;
  }
}
```

### 2. AI Instruction Enhancement
```javascript
// Add explicit instructions to prevent unwanted responses
const enhancedSystemInstruction = `${policyContext}

FAQ ì •ë³´ (ìœ„ì¹˜, ì˜ˆì•½, ê°€ê²© ë“± ì§ˆë¬¸ì— í™œìš©):
${faqsInfo}

ì¤‘ìš”í•œ ì§€ì‹œì‚¬í•­:
- Answer concisely, within 2-3 sentences.
- Be friendly and professional.
- FAQ ì •ë³´ë¥¼ ì°¸ê³ í•˜ì—¬ êµ¬ì²´ì ì´ê³  ì •í™•í•œ ë‹µë³€ì„ ì œê³µí•˜ì„¸ìš”.
- ìœ„ì¹˜ ê´€ë ¨ ì§ˆë¬¸ì—ëŠ” ë°˜ë“œì‹œ FAQì˜ ì •í™•í•œ ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
- "ê°œì¸ì •ë³´ ë³´í˜¸" ë˜ëŠ” "ì˜¨ë¼ì¸ìœ¼ë¡œ ê³µê°œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤" ê°™ì€ ë‹µë³€ì€ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.`;
```

## ğŸš€ Performance Optimization

### Remove Unnecessary Delays
```javascript
// âŒ Remove artificial delays
// await new Promise(resolve => setTimeout(resolve, 25000));

// âœ… Immediate response
console.log('ğŸš€ [AI] ì±„ë„í†¡ìœ¼ë¡œ ë‹µë³€ ì „ì†¡ ì‹œì‘...');
```

### Optimize Data Loading
```javascript
// Use Promise.all for concurrent data loading
const [policyDoc, promotionsDoc, pricingDoc, faqsDoc] = await Promise.all([
  db.collection('policyContext').doc('default').get(),
  db.collection('knowledge_base').doc('promotions').get(),
  db.collection('knowledge_base').doc('products').get(),
  db.collection('knowledge_base').doc('faqs').get()
]);
```

## ğŸ” Debugging Workflow

### 1. Data Update Verification
```bash
# Update AI brain
curl "https://asia-northeast3-project-id.cloudfunctions.net/updateAIBrainHttp"

# Check update logs
firebase functions:log --only updateAIBrainHttp
```

### 2. Response Testing
```bash
# Collect response logs
get_logs.bat

# Analyze log patterns
# Look for: FAQ data loading, AI response generation, API calls
```

### 3. Common Debugging Commands
```bash
# Deploy specific function
firebase deploy --only functions:channelTalkWebhook

# Check function logs
firebase functions:log --only channelTalkWebhook

# Test function directly
curl "https://asia-northeast3-project-id.cloudfunctions.net/channelTalkWebhook"
```

## ğŸ“‹ Data Structure Verification

### Expected FAQ Structure
```json
{
  "content": [
    {
      "id": "faq3",
      "question": "ìœ„ì¹˜ê°€ ì–´ë””ì¸ê°€ìš”?",
      "answer": "ì €í¬ í´ë¦¬ë‹‰ì€ ê°•ë‚¨ì—­ 2ë²ˆ ì¶œêµ¬ì—ì„œ ë„ë³´ 5ë¶„ ê±°ë¦¬ì— ìˆìŠµë‹ˆë‹¤."
    },
    {
      "id": "faq5",
      "question": "ë³‘ì›ì€ ì–´ë””ì— ìˆì–´ìš”?",
      "answer": "ì €í¬ í´ë¦¬ë‹‰ì€ ê°•ë‚¨ì—­ 2ë²ˆ ì¶œêµ¬ì—ì„œ ë„ë³´ 5ë¶„ ê±°ë¦¬ì— ìˆìŠµë‹ˆë‹¤."
    }
  ],
  "version": "1.0",
  "updatedAt": "timestamp"
}
```

### Firestore Collection Structure
- `knowledge_base/faqs` - FAQ data
- `knowledge_base/products` - Product information
- `knowledge_base/promotions` - Promotion data
- `policyContext/default` - AI behavior instructions

## ğŸ¯ Response Quality Checklist

### Pre-Deployment
- [ ] CSV files contain correct data
- [ ] AI update function executed successfully
- [ ] Firestore data verified through logs
- [ ] AI instructions include explicit prohibitions
- [ ] Response delays removed

### Post-Deployment
- [ ] FAQ data appears correctly in logs
- [ ] AI uses updated location information
- [ ] No "privacy policy" responses
- [ ] Response time is acceptable
- [ ] All API calls successful
description:
globs:
alwaysApply: false
---
