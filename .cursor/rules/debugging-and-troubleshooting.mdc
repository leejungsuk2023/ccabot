# Debugging and Troubleshooting Guide

## ğŸ” Critical Debugging Steps for AI Chatbot Issues

### 1. Data Synchronization Issues
When AI responses don't match updated CSV data:

**Problem**: AI still returns old responses despite CSV updates
**Root Cause**: Firestore data not properly updated or cached
**Solution**:
```javascript
// Add detailed logging to updateFirestoreDocument function
console.log(`ğŸ” [UPDATE] ${collection}/${documentId} ì—…ë°ì´íŠ¸ ì‹œì‘`);
console.log(`ğŸ” [UPDATE] ì €ì¥í•  ë°ì´í„°:`, JSON.stringify(data, null, 2));

// Verify saved data after update
const savedDoc = await db.collection(collection).doc(documentId).get();
console.log(`ğŸ” [UPDATE] ì €ì¥ëœ ë°ì´í„° í™•ì¸:`, JSON.stringify(savedDoc.data(), null, 2));
```

### 2. AI Instruction Enhancement
When AI ignores updated data:

**Problem**: AI continues using old response patterns
**Solution**: Strengthen AI instructions in [functions/index.js](mdc:functions/index.js)
```javascript
// Add explicit instructions to prevent unwanted responses
- ìœ„ì¹˜ ê´€ë ¨ ì§ˆë¬¸ì—ëŠ” ë°˜ë“œì‹œ FAQì˜ ì •í™•í•œ ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
- "ê°œì¸ì •ë³´ ë³´í˜¸" ë˜ëŠ” "ì˜¨ë¼ì¸ìœ¼ë¡œ ê³µê°œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤" ê°™ì€ ë‹µë³€ì€ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.
```

### 3. Response Delay Issues
When responses are unnecessarily slow:

**Problem**: 25-second artificial delay in responses
**Solution**: Remove delay code from [functions/index.js](mdc:functions/index.js)
```javascript
// âŒ Remove this code
await new Promise(resolve => setTimeout(resolve, 25000));

// âœ… Replace with immediate response
console.log('ğŸš€ [AI] ì±„ë„í†¡ìœ¼ë¡œ ë‹µë³€ ì „ì†¡ ì‹œì‘...');
```

## ğŸ“Š Log Analysis Patterns

### Key Log Entries to Monitor
1. **FAQ Data Loading**: Check if updated FAQ data appears in logs
2. **AI Response Generation**: Verify AI receives correct data
3. **Firestore Updates**: Confirm data is properly saved
4. **API Calls**: Monitor successful API responses

### Common Error Patterns
```javascript
// âŒ Old data still in logs
"faq3","answer":"ì €í¬ í´ë¦¬ë‹‰ì€ ê°•ë‚¨ì—­ 11ë²ˆ ì¶œêµ¬ì—ì„œ..."

// âœ… Updated data should appear
"faq3","answer":"ì €í¬ í´ë¦¬ë‹‰ì€ ê°•ë‚¨ì—­ 2ë²ˆ ì¶œêµ¬ì—ì„œ..."
```

## ğŸš€ Deployment Verification

### Pre-Deployment Checklist
- [ ] CSV files updated with correct data
- [ ] AI update function executed successfully
- [ ] Firestore data verified through logs
- [ ] AI instructions enhanced to prevent unwanted responses
- [ ] Response delays removed

### Post-Deployment Verification
```bash
# Collect logs for analysis
get_logs.bat

# Check AI update function logs
firebase functions:log --only updateAIBrainHttp

# Test AI response
curl "https://asia-northeast3-project-id.cloudfunctions.net/updateAIBrainHttp"
```

## ğŸ”§ Data Flow Debugging

### Expected Data Flow
```
CSV Update â†’ AI Update Function â†’ Firestore â†’ AI Response Function â†’ ChannelTalk
```

### Debugging Points
1. **CSV File**: Verify [functions/faqs.csv](mdc:functions/faqs.csv) content
2. **Update Function**: Check [functions/update_ai_brain.js](mdc:functions/update_ai_brain.js) execution
3. **Firestore**: Verify data in `knowledge_base/faqs` collection
4. **AI Function**: Check [functions/index.js](mdc:functions/index.js) data loading
5. **Response**: Monitor actual AI responses

## ğŸ¯ Common Issues and Solutions

### Issue: AI Returns "Privacy Policy" Response
**Cause**: AI instructions not strong enough
**Solution**: Add explicit prohibition in system instructions

### Issue: Old Data Persists
**Cause**: Firestore cache or update failure
**Solution**: Add verification logging and re-run update function

### Issue: Slow Response Times
**Cause**: Artificial delays in code
**Solution**: Remove setTimeout calls

### Issue: FAQ Data Not Loading
**Cause**: Wrong collection/document path
**Solution**: Verify Firestore path: `knowledge_base/faqs`
description:
globs:
alwaysApply: false
---
