# Multilingual AI Response Rules

## Critical: Always implement language detection and forced response templates

### âœ… CORRECT Implementation
```javascript
// 1. Extract language from ChannelTalk webhook
const language = messageEntity.language || 'ko';

// 2. Create language-specific forced response templates
let languageTemplate = '';
if (language === 'th') {
  languageTemplate = '\n\n[CRITICAL INSTRUCTION] The user is speaking Thai. You MUST respond in Thai language only. Example response format: "à¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¹ˆà¸°! à¸‚à¸­à¸šà¸„à¸¸à¸“à¸ªà¸³à¸«à¸£à¸±à¸šà¸„à¸³à¸–à¸²à¸¡à¸‚à¸­à¸‡à¸„à¸¸à¸“..."';
} else if (language === 'en') {
  languageTemplate = '\n\n[CRITICAL INSTRUCTION] The user is speaking English. You MUST respond in English language only. Example response format: "Hello! Thank you for your question..."';
} else if (language === 'ja') {
  languageTemplate = '\n\n[CRITICAL INSTRUCTION] The user is speaking Japanese. You MUST respond in Japanese language only. Example response format: "ã“ã‚“ã«ã¡ã¯ï¼ã”è³ªå•ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™..."';
} else if (language === 'zh') {
  languageTemplate = '\n\n[CRITICAL INSTRUCTION] The user is speaking Chinese. You MUST respond in Chinese language only. Example response format: "æ‚¨å¥½ï¼æ„Ÿè°¢æ‚¨çš„æé—®..."';
} else if (language === 'vi') {
  languageTemplate = '\n\n[CRITICAL INSTRUCTION] The user is speaking Vietnamese. You MUST respond in Vietnamese language only. Example response format: "Xin chÃ o! Cáº£m Æ¡n báº¡n Ä‘Ã£ há»i..."';
} else if (language === 'id') {
  languageTemplate = '\n\n[CRITICAL INSTRUCTION] The user is speaking Indonesian. You MUST respond in Indonesian language only. Example response format: "Halo! Terima kasih atas pertanyaan Anda..."';
} else if (language === 'ru') {
  languageTemplate = '\n\n[CRITICAL INSTRUCTION] The user is speaking Russian. You MUST respond in Russian language only. Example response format: "Ğ—Ğ´Ñ€Ğ°Ğ²ÑÑ‚Ğ²ÑƒĞ¹Ñ‚Ğµ! Ğ¡Ğ¿Ğ°ÑĞ¸Ğ±Ğ¾ Ğ·Ğ° Ğ²Ğ°Ñˆ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ..."';
} else {
  languageTemplate = '\n\n[CRITICAL INSTRUCTION] The user is speaking Korean. You MUST respond in Korean language only. Example response format: "ì•ˆë…•í•˜ì„¸ìš”! ì§ˆë¬¸í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤..."';
}

// 3. Include language template in system instruction
const enhancedSystemInstruction = `${policyContext}

í˜„ì¬ í”„ë¡œëª¨ì…˜ ì •ë³´:
${promotionsInfo}

ì œí’ˆ ê°€ê²© ì •ë³´:
${pricingInfo}

ì¤‘ìš”í•œ ì§€ì‹œì‚¬í•­:
- Answer concisely, within 2-3 sentences.
- Be friendly and professional.

[í•µì‹¬ ìˆ˜ì •] ì–¸ì–´ ì§€ì‹œì‚¬í•­:
CRITICAL: The user's language code is "${language}". You MUST respond ONLY in this exact language. Do NOT use Korean or any other language. If language code is "th", respond in Thai. If language code is "en", respond in English. If language code is "ko", respond in Korean.${languageTemplate}`;

// 4. Use enhanced system instruction in Gemini request
const geminiRequestBody = {
  contents: [...conversationHistory, { role: 'user', parts: [{ text: text }] }],
  systemInstruction: { parts: [{ text: enhancedSystemInstruction }] }
};
```

### âŒ INCORRECT Implementation (Causes language mismatch)
```javascript
// Missing language detection
const geminiRequestBody = {
  contents: [...conversationHistory, { role: 'user', parts: [{ text: text }] }],
  systemInstruction: { parts: [{ text: policyContext }] }
};

// Weak language instruction
const systemInstruction = `${policyContext}\n\nRespond in the same language as the user.`;
```

## Key Requirements:

### 1. Language Detection
- Extract `language` from `messageEntity.language`
- Provide fallback to Korean (`'ko'`) if not detected
- Log language for debugging: `console.log('ğŸ” [Webhook] ìµœì¢… ì‚¬ìš© ì–¸ì–´:', language);`

### 2. Forced Response Templates
- Use `[CRITICAL INSTRUCTION]` prefix
- Include example response format in target language
- Specify exact language requirements
- Prevent AI from using wrong language

### 3. System Instruction Enhancement
- Combine policy context with language instructions
- Include promotions and pricing information
- Add response length constraints (2-3 sentences)
- Use multiple reinforcement techniques

### 4. Debugging and Logging
```javascript
console.log('ğŸ” [Webhook] ì±„ë„í†¡ì—ì„œ ë°›ì€ ì–¸ì–´ ì •ë³´:', messageEntity.language);
console.log('ğŸ” [Webhook] ìµœì¢… ì‚¬ìš© ì–¸ì–´:', language);
console.log('ğŸ” [Webhook] ì‚¬ìš©ì ë©”ì‹œì§€:', text);
console.log('ğŸ” [AI] Geminiì—ê²Œ ë³´ë‚´ëŠ” ìµœì¢… ìš”ì²­ ë°ì´í„°:', JSON.stringify(geminiRequestBody, null, 2));
```

## Supported Languages:
- Korean (ko) - Default
- Thai (th)
- English (en)
- Japanese (ja)
- Chinese (zh)
- Vietnamese (vi)
- Indonesian (id)
- Russian (ru)

## Common Error Patterns:
- Thai question â†’ Korean response
- Language detection working but AI ignoring instructions
- Inconsistent language responses

## Debugging Checklist:
1. âœ… Language extraction from webhook
2. âœ… Language-specific template creation
3. âœ… Strong language enforcement in system instruction
4. âœ… Example response format in target language
5. âœ… Comprehensive logging for debugging
description:
globs:
alwaysApply: false
---
